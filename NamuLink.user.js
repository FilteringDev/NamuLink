// ==UserScript==
// @name         NamuLink
// @encoding     utf-8
// @namespace    https://github.com/List-KR/NamuLink
// @homepageURL  https://github.com/List-KR/NamuLink
// @supportURL   https://github.com/List-KR/NamuLink/issues
// @updateURL    https://cdn.jsdelivr.net/gh/List-KR/NamuLink@latest/NamuLink.user.js
// @downloadURL  https://cdn.jsdelivr.net/gh/List-KR/NamuLink@latest/NamuLink.user.js
// @license      MIT
//
// @version      3.16.5
// @author       PiQuark6046 and contributors
//
// @match        https://namu.wiki/*
//
// @description        NamuLink blocks the license-abused PowerLink advertisement on NamuWiki.
// @description:ko     NamuLink는 나무위키에 있는 라이선스를 위반한 파워링크 광고를 차단합니다.
//
// @grant        unsafeWindow
// @run-at       document-start
// @inject-into  page
// ==/UserScript==
// Used libraries:
(()=>{var h=class{value;next;constructor(e){this.value=e}},d=class{#e;#t;#n;constructor(){this.clear()}enqueue(e){let n=new h(e);this.#e?(this.#t.next=n,this.#t=n):(this.#e=n,this.#t=n),this.#n++}dequeue(){let e=this.#e;if(e)return this.#e=this.#e.next,this.#n--,e.value}clear(){this.#e=void 0,this.#t=void 0,this.#n=0}get size(){return this.#n}*[Symbol.iterator](){let e=this.#e;for(;e;)yield e.value,e=e.next}};var y={bind(r,e,n){return r.bind(n)}};function f(r){if(!((Number.isInteger(r)||r===Number.POSITIVE_INFINITY)&&r>0))throw new TypeError("Expected `concurrency` to be a number from 1 and up");let e=new d,n=0,t=()=>{n--,e.size>0&&e.dequeue()()},l=async(u,o,c)=>{n++;let p=(async()=>u(...c))();o(p);try{await p}catch{}t()},a=(u,o,c)=>{e.enqueue(y.bind(l.bind(void 0,u,o,c))),(async()=>(await Promise.resolve(),n<r&&e.size>0&&e.dequeue()()))()},i=(u,...o)=>new Promise(c=>{a(u,c,o)});return Object.defineProperties(i,{activeCount:{get:()=>n},pendingCount:{get:()=>e.size},clearQueue:{value(){e.clear()}}}),i}function T(r){if(!Number.isInteger(r.Count))throw new Error("MultithreadArrayOptions.Count should be an integer");if(r.Count<=0)throw new Error("MultithreadArrayOptions.Count should be greater than 0")}function E(r,e){T(e);let n=new Array(Math.ceil(r.length/e.Count));for(var t=0;t<n.length;t++)n[t]=r.slice(t===0?t:t*e.Count,(t+1)*e.Count>r.length?r.length:(t+1)*e.Count);return n}var s=typeof unsafeWindow<"u"?unsafeWindow:window,H=new Event("namuwikiunloadedadvert"),M=new Event("namuwikiloadedadvert");s.String.prototype.indexOf=new Proxy(s.String.prototype.indexOf,{apply(r,e,n){let t=Reflect.apply(r,e,n);return typeof n[0]=="string"&&n[0]==="key"&&s.dispatchEvent(H),t}});var m=[],v=r=>{m.push(...r),r.forEach(e=>{e.remove()})},A=()=>{console.debug("[NamuLink:index]: ShowElements:",m),m=m.filter(r=>r.parentElement!==null),m.forEach(r=>{r.style.removeProperty("display")}),m=[]},g=r=>{let e=[],n=r.parentElement;for(;n!==null;)e.push(n),n=n.parentElement;return e},S=r=>{var e=r.filter(t=>t instanceof HTMLElement);let n=[];return e=e.filter(t=>t.innerText.length<25),e=e.filter(t=>Array.from(t.querySelectorAll("*")).filter(i=>i instanceof HTMLElement).some(i=>Number(getComputedStyle(i).getPropertyValue("margin-bottom").replace(/px$/,""))>=4)),e=e.filter(t=>Array.from(t.querySelectorAll("*")).filter(a=>a instanceof HTMLIFrameElement).length===0),e=e.filter(t=>t.querySelectorAll('span[id^="fn-"] + a[href^="#rfn-"]').length===0),e=e.filter(t=>!Array.from(t.parentElement.querySelectorAll("span")).some(l=>l.innerHTML.includes("\uC2E4\uC2DC\uAC04 \uAC80\uC0C9\uC5B4"))),e=e.filter(t=>!Array.from(t.querySelectorAll("*")).some(l=>l.innerHTML.includes("\uC2E4\uC2DC\uAC04 \uAC80\uC0C9\uC5B4"))),e=e.filter(t=>!Array.from(t.querySelectorAll('div[class*=" "] > *')).some(l=>l.innerText.includes("\uBD84\uB958"))),e=e.filter(t=>!g(t).some(l=>l.offsetWidth===document.body.offsetWidth&&l.offsetHeight<200)),e=e.filter(t=>!Array.from(t.querySelectorAll('img[src*="image/svg"] ~ img[src] ~ noscript')).some(l=>l.textContent.startsWith("<img"))),n.push(...e.filter(t=>Array.from(t.querySelectorAll("*")).filter(i=>i instanceof HTMLElement).filter(i=>getComputedStyle(i).getPropertyValue("animation-iteration-count")==="infinite").length>=6)),e=e.filter(t=>{let a=Array.from(t.querySelectorAll("*")).filter(i=>i instanceof HTMLElement);return a.some(i=>Number(getComputedStyle(i).getPropertyValue("margin-bottom").replace(/px$/,""))>=10)&&a.every(i=>Number(getComputedStyle(i).getPropertyValue("margin-left").replace(/px$/,""))<=10)}),n.push(...e.filter(t=>{let a=Array.from(t.querySelectorAll("*")).filter(o=>o instanceof HTMLElement),u=Array.from(t.parentElement?.querySelectorAll("*")??[]).filter(o=>o instanceof HTMLElement);return a.every(o=>!o.innerText.includes("alt='external/"))&&u.filter(o=>o.nextElementSibling===t&&!(o instanceof HTMLHeadingElement)).length>0})),n},L=async()=>{let r=[];r.push(...Array.from(s.document.querySelectorAll('div[class] div[class*=" "]:has(span ~ ul li) ~ div div[class] > div[class] div[class] ~ div[class]'))),r.push(...Array.from(s.document.querySelectorAll('div:not([class*=" "]) div[class] div[class*=" "]')));let e=[],n=f((navigator.hardwareConcurrency??4)<4?4:navigator.hardwareConcurrency),t=[];for(let l of E(r,{Count:2}))t.push(n(()=>S(l)));e=await Promise.all(t).then(l=>l.flat()),console.debug("[NamuLink:index]: HideLeftoverElement:",e),v(e)},C=null;s.EventTarget.prototype.addEventListener=new Proxy(s.EventTarget.prototype.addEventListener,{apply(r,e,n){return typeof n[1]=="function"&&n[0]==="click"&&e instanceof HTMLElement&&(n[1].toString().includes("currentTarget")||/('|")X('|")\) {0,}&&/.test(n[1].toString())&&/('|")Y('|")\) {0,}&&/.test(n[1].toString()))&&e.innerText.replaceAll(/[^a-zA-Z0-9\uAC00-\uD7A3./]+/gu,"").length<=100&&/^.+\..+$/.test(e.innerText.replaceAll(/[^a-zA-Z0-9\uAC00-\uD7A3./]+/gu,""))&&!/편집 권한이 부족합니다.+ACL 탭/.test(e.innerText)&&(C=e,s.dispatchEvent(M)),Reflect.apply(r,e,n)}});var w=r=>{var e=r.filter(t=>t instanceof HTMLElement);let n=[];return e=e.filter(t=>Array.from(t.querySelectorAll("*")).filter(i=>i instanceof HTMLElement).some(i=>Number(getComputedStyle(i).getPropertyValue("margin-bottom").replace(/px$/,""))>=4)),e=e.filter(t=>Array.from(t.querySelectorAll("*")).filter(a=>a instanceof HTMLIFrameElement).length===0),e=e.filter(t=>t.querySelectorAll('span[id^="fn-"] + a[href^="#rfn-"]').length===0),e=e.filter(t=>!Array.from(t.parentElement.querySelectorAll("span")).some(l=>l.innerHTML.includes("\uC2E4\uC2DC\uAC04 \uAC80\uC0C9\uC5B4"))),e=e.filter(t=>!Array.from(t.querySelectorAll("*")).some(l=>l.innerHTML.includes("\uC2E4\uC2DC\uAC04 \uAC80\uC0C9\uC5B4"))),e=e.filter(t=>!Array.from(t.querySelectorAll('div[class*=" "] > *')).some(l=>l.innerText.includes("\uBD84\uB958"))),e=e.filter(t=>!g(t).some(l=>l.offsetWidth===document.body.offsetWidth&&l.offsetHeight<200)),e=e.filter(t=>!Array.from(t.querySelectorAll('div[class*=" "] a:has(svg path)')).some(l=>Number(getComputedStyle(l).getPropertyValue("margin-top").replace(/px$/,""))>10)),e=e.filter(t=>!Array.from(t.querySelectorAll('img[src*="image/svg"] ~ img[src] ~ noscript')).some(l=>l.textContent.startsWith("<img"))),n.push(...e.filter(t=>t.contains(C))),n},x=async()=>{let r=[];r.push(...Array.from(s.document.querySelectorAll('div[class] div[class*=" "]:has(span ~ ul li) ~ div div[class] > div[class] div[class] ~ div[class]'))),r.push(...Array.from(s.document.querySelectorAll('div:not([class*=" "]) div[class] div[class*=" "]')));let e=[],n=f((navigator.hardwareConcurrency??4)<4?4:navigator.hardwareConcurrency),t=[];for(let l of E(r,{Count:2}))t.push(n(()=>w(l)));e=await Promise.all(t).then(l=>l.flat()),console.debug("[NamuLink:index]: HideLeftoverElement:",e),v(e)};s.addEventListener("namuwikiloadedadvert",x);s.addEventListener("namuwikiunloadedadvert",L);s.addEventListener("namuwikifristvisit",L);s.addEventListener("namuwikinavigation",A);})();
