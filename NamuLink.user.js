// ==UserScript==
// @name         NamuLink
// @encoding     utf-8
// @namespace    https://github.com/List-KR/NamuLink
// @homepageURL  https://github.com/List-KR/NamuLink
// @supportURL   https://github.com/List-KR/NamuLink/issues
// @updateURL    https://cdn.jsdelivr.net/gh/List-KR/NamuLink@latest/NamuLink.user.js
// @downloadURL  https://cdn.jsdelivr.net/gh/List-KR/NamuLink@latest/NamuLink.user.js
// @license      MIT
//
// @version      3.3.3
// @author       PiQuark6046 and contributors
//
// @match        https://namu.wiki/*
//
// @description        NamuLink blocks the license-abused PowerLink advertisement on NamuWiki.
// @description:ko     NamuLink는 나무위키에 있는 라이선스를 위반한 파워링크 광고를 차단합니다.
//
// @grant        unsafeWindow
// @run-at       document-start
// @inject-into  page
// ==/UserScript==
// Used libraries:
(()=>{var h=class{value;next;constructor(e){this.value=e}},m=class{#e;#t;#n;constructor(){this.clear()}enqueue(e){let n=new h(e);this.#e?(this.#t.next=n,this.#t=n):(this.#e=n,this.#t=n),this.#n++}dequeue(){let e=this.#e;if(e)return this.#e=this.#e.next,this.#n--,e.value}clear(){this.#e=void 0,this.#t=void 0,this.#n=0}get size(){return this.#n}*[Symbol.iterator](){let e=this.#e;for(;e;)yield e.value,e=e.next}};var p={bind(t,e,n){return t.bind(n)}};function f(t){if(!((Number.isInteger(t)||t===Number.POSITIVE_INFINITY)&&t>0))throw new TypeError("Expected `concurrency` to be a number from 1 and up");let e=new m,n=0,i=()=>{n--,e.size>0&&e.dequeue()()},r=async(o,u,l)=>{n++;let E=(async()=>o(...l))();u(E);try{await E}catch{}i()},c=(o,u,l)=>{e.enqueue(p.bind(r.bind(void 0,o,u,l))),(async()=>(await Promise.resolve(),n<t&&e.size>0&&e.dequeue()()))()},a=(o,...u)=>new Promise(l=>{c(o,l,u)});return Object.defineProperties(a,{activeCount:{get:()=>n},pendingCount:{get:()=>e.size},clearQueue:{value(){e.clear()}}}),a}function w(t){if(!Number.isInteger(t.Count))throw new Error("MultithreadArrayOptions.Count should be an integer");if(t.Count<=0)throw new Error("MultithreadArrayOptions.Count should be greater than 0")}function y(t,e){w(e);let n=[];for(var i=0;i<e.Count;i++)n.push(t.slice(i*Math.floor(t.length/e.Count),(i+1)*Math.floor(t.length/e.Count)));t=t.slice(e.Count*Math.floor(t.length/e.Count));for(var r=0;r<t.length;r++)n[r].push(t[r]);return n}var s=typeof unsafeWindow<"u"?unsafeWindow:window,C=new Event("namuwikinavigationwithadvert"),v=new Event("namuwikinavigation"),L=new Event("namuwikifristvisit");s.TextDecoder.prototype.decode=new Proxy(s.TextDecoder.prototype.decode,{apply(t,e,n){let i=Reflect.apply(t,e,n);return i.includes("//adcr.naver.com/adcr?")?(console.debug("[NamuLink:index]: TextDecoder.prototype.decode:",[t,e,n]),s.dispatchEvent(v),s.dispatchEvent(C),new Error):((i==="enable_ads"||decodeURIComponent(location.href).includes(i))&&s.dispatchEvent(v),i)}});s.Array.prototype.push=new Proxy(s.Array.prototype.push,{apply(t,e,n){n.toString().includes("//adcr.naver.com/adcr?")?(console.debug("[NamuLink:index]: Array.prototype.push:",[t,e,n]),s.dispatchEvent(L)):Reflect.apply(t,e,n)}});var d=[],M=t=>{d.push(...t),t.forEach(e=>{e.style.setProperty("display","none","important")})},H=()=>{console.debug("[NamuLink:index]: ShowElements:",d),d=d.filter(t=>t.parentElement!==null),d.forEach(t=>{t.style.removeProperty("display")}),d=[]},T=t=>{let e=t.filter(r=>r instanceof HTMLElement);var n=[];let i=[];return n=e.filter(r=>r.innerText.length<25),n=n.filter(r=>Array.from(r.querySelectorAll("*")).filter(o=>o instanceof HTMLElement).some(o=>Number(getComputedStyle(o).getPropertyValue("margin-bottom").replace(/px$/,""))>=4)),n=n.filter(r=>Array.from(r.querySelectorAll("*")).filter(a=>a instanceof HTMLIFrameElement).length===0),n=n.filter(r=>r.querySelectorAll('span[id^="fn-"] + a[href^="#rfn-"]').length===0),i.push(...n.filter(r=>Array.from(r.querySelectorAll("*")).filter(o=>o instanceof HTMLElement).filter(o=>getComputedStyle(o).getPropertyValue("animation-iteration-count")==="infinite").length>=6)),n=n.filter(r=>{let a=Array.from(r.querySelectorAll("*")).filter(o=>o instanceof HTMLElement);return a.some(o=>Number(getComputedStyle(o).getPropertyValue("margin-bottom").replace(/px$/,""))>=10)&&a.every(o=>Number(getComputedStyle(o).getPropertyValue("margin-left").replace(/px$/,""))<=10)}),i.push(...n.filter(r=>{let a=Array.from(r.querySelectorAll("*")).filter(l=>l instanceof HTMLElement),u=Array.from(r.parentElement?.querySelectorAll("*")??[]).filter(l=>l instanceof HTMLElement);return a.every(l=>!l.innerText.includes("alt='external/"))&&u.filter(l=>l.nextElementSibling===r&&!(l instanceof HTMLHeadingElement)).length>0})),i},g=async()=>{let t=Array.from(s.document.querySelectorAll('article div:not([class*=" "]):has(h1)~ div * ~ div[class]'));t.push(...Array.from(s.document.querySelectorAll('article div:not([class*=" "]):has(h1) ~ *'))),t.push(...Array.from(s.document.querySelectorAll('article div:not([class*=" "]) div[class] div[class*=" "]')));let e=[],n=f((navigator.hardwareConcurrency??4)<4?4:navigator.hardwareConcurrency),i=[];for(let r of y(t,{Count:(navigator.hardwareConcurrency??4)<4?4:navigator.hardwareConcurrency}))i.push(n(()=>T(r)));e=await Promise.all(i).then(r=>r.flat()),console.debug("[NamuLink:index]: HideLeftoverElement:",e),M(e)};s.addEventListener("namuwikinavigationwithadvert",g);s.addEventListener("namuwikifristvisit",g);s.addEventListener("namuwikinavigation",H);})();
